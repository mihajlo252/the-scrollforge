import{c as q,g as E,r as a,s as n,t as r,j as e,m as V,B as i,a as j,P as v}from"./index-BwH6pDYt.js";const H=q("/chat")({component:W});function W(){var R;const o=JSON.parse(E()).user.id,m=JSON.parse(E()).user.user_metadata.username,[I,N]=a.useState(""),[d,x]=a.useState([]),[A,w]=a.useState(!1),[M,f]=a.useState([]),[_,p]=a.useState(!1),[c,S]=a.useState(""),[P,F]=a.useState([]),[h,U]=a.useState(""),[k,u]=a.useState(!1),[B,J]=a.useState([]),[O,g]=a.useState(!1),T=async t=>{if(t.preventDefault(),c===""){r({style:"bg-error text-base-100",message:"Please select a chat room"});return}if(t.target[0].value===""){r({style:"bg-error text-base-100",message:"Please enter a message"});return}const{error:s}=await n.from("messages").insert({content:t.target[0].value,user_id:o,username:m,chatRoom:c});N(""),s&&console.error("Error sending message:",s)},z=t=>{t.preventDefault(),N(t.target.value)},G=async()=>{const{data:t,error:s}=await n.from("messages").select("*").eq("chatRoom",c).order("created_at",{ascending:!0}).limit(50);if(s){console.error("Error fetching messages",s);return}if(!t||!Array.isArray(t)){x([]);return}x(t)},C=a.useRef(null);a.useEffect(()=>{var t;d.length&&((t=C.current)==null||t.scrollIntoView({behavior:"smooth",block:"end"}))},[d.length]);const D=async t=>{if(t.preventDefault(),h===""){r({style:"bg-error text-base-100",message:"Please enter a room name"});return}w(!0);const{error:s}=await n.from("parties").insert({name:h,creator:o});if(s){r({style:"bg-error text-base-100",message:"Error creating room:"+s});return}else r({style:"bg-success text-base-100",message:"Room created!"}),u(!1),w(!1),await b()},L=async()=>{const{data:t}=await n.from("partyProfiles").select("*").eq("memberID",o);if(!t){r({style:"bg-error text-base-100",message:"You are not in any parties."});return}return t.map(s=>s.partyID)},b=async()=>{const t=await L();if(!t)return;const{data:s}=await n.from("parties").select("*").in("id",[...t]);if(!s){r({style:"bg-error text-base-100",message:"You are not in any parties."});return}F(s.map(l=>l))},Y=async()=>{g(!0);const{data:t}=await n.from("parties").select("*");if(!t){r({style:"bg-error text-base-100",message:"There are no parties."});return}J(t.map(s=>s)),S(t[0].id)},$=async t=>{const{error:s}=await n.from("partyProfiles").insert({memberID:o,partyID:t});if(s){r({style:"bg-error text-base-100",message:"Error joining party:"+s});return}else r({style:"bg-success text-base-100",message:"Joined party!"}),await b(),g(!1)};return a.useEffect(()=>{b()},[]),a.useEffect(()=>{if(!c)return;x([]);const t=n.channel(c);return t.on("presence",{event:"join"},({newPresences:s})=>{f(l=>[...l,s[0].user]),s[0].user!==m&&r({style:"bg-success text-base-100",message:`${s[0].user} joined the chat`})}).on("presence",{event:"leave"},({leftPresences:s})=>{f(l=>l.filter(y=>y!==s[0].user)),s[0].user!==m&&r({style:"bg-error text-base-100",message:`${s[0].user} left the chat`})}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},s=>{x(l=>[...l,s.new])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},s=>{x(l=>l.filter(y=>y.id!==s.old.id))}).subscribe(async s=>{s==="SUBSCRIBED"&&await G()}),t.track({user:m,online_at:new Date().toISOString()}),()=>{n.removeChannel(t),f([])}},[c]),e.jsxs(V.main,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"m-0 relative h-full w-full p-0",children:[e.jsxs(i,{styles:"w-full flex px-5 py-5 gap-2 justify-between overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col gap-2 h-full",children:[e.jsx("ul",{className:"flex flex-col gap-2 overflow-y-scroll h-full",children:P.map(t=>e.jsx("li",{children:e.jsx(j,{style:"border-accent text-accent hover:border-accent hover:bg-accent",event:()=>S(t.id),children:t.name})},t.id))}),e.jsx(j,{style:"border-accent text-accent hover:border-accent hover:bg-accent mt-auto",event:()=>Y(),children:"Join Party"}),e.jsx("button",{className:"btn btn-primary mt-auto",onClick:()=>u(!0),children:"Create Party"})]}),e.jsxs("div",{className:"flex flex-col gap-5 w-full h-full",children:[e.jsx(i,{styles:"w-full h-full flex flex-col flex-grow px-5 py-5 gap-5 overflow-y-scroll relative",children:c&&e.jsxs(e.Fragment,{children:[e.jsxs("ul",{className:"flex flex-col justify-start gap-2",children:[e.jsxs("li",{className:"flex flex-col text-left",children:[e.jsx("p",{className:"text-center text-xs text-slate-400",children:"System message"}),e.jsxs("p",{className:"text-center text-accent",children:["Welcome to ",(R=P.find(t=>t.id===c))==null?void 0:R.name]})]}),d.map((t,s)=>e.jsx("li",{className:"flex flex-col text-left",children:e.jsxs("div",{className:"relative flex flex-col gap-2",children:[e.jsxs("p",{className:`text-xl font-bold capitalize ${t.user_id===o?"text-accent":"text-primary"}`,children:[t.username,t.user_id===o&&e.jsx("span",{className:"text-xs text-slate-400",children:" (Me)"})]}),e.jsxs("div",{className:"flex justify-between",children:[t.content,e.jsx("span",{className:"flex items-center justify-end text-accent",children:new Date(t.created_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})})]})]})},s))]}),e.jsx("div",{ref:C,className:"px-5 text-left"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-accent",onClick:()=>p(!0),children:"Active"}),e.jsxs("form",{onSubmit:T,className:"flex gap-2 flex-1",children:[e.jsx("input",{type:"text",value:I,onChange:z,placeholder:"Type a message...",className:"input input-bordered flex-grow"}),e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Send"})]})]})]})]}),e.jsx(v,{closerFunc:p,toggle:_,children:e.jsxs(i,{styles:"w-1/5 px-5 py-5 relative flex flex-col justify-start items-start h-max",children:[e.jsx(j,{style:"border-secondary text-secondary hover:border-secondary hover:bg-secondary absolute top-5 right-5",event:()=>p(!1),children:"X"}),e.jsx("h1",{className:" text-2xl font-semibold text-primary",children:"Active"}),e.jsx("ul",{className:"flex flex-col",children:M.map((t,s)=>e.jsx("li",{className:"flex flex-col text-left",children:e.jsx("p",{className:"text-xl font-bold capitalize text-success",children:t})},s))})]})}),e.jsx(v,{closerFunc:u,toggle:k,children:e.jsx("form",{onSubmit:D,children:e.jsxs(i,{styles:"w-full flex flex-col gap-5 px-20 py-10",children:[e.jsxs("div",{className:"flex flex-col gap-5",children:[e.jsx("label",{htmlFor:"roomNameID",className:"text-2xl",children:"Name Your Party"}),e.jsx("input",{type:"text",placeholder:"Name",id:"roomNameID",value:h,onChange:t=>U(t.target.value),className:"rounded-xl border-2 border-slate-900 bg-base-300 p-2 text-base-content"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary w-[80%] flex-1",disabled:!!A,children:"Create party"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>u(!1),children:"Cancel"})]})]})})}),e.jsx(v,{closerFunc:g,toggle:O,children:e.jsx("form",{onSubmit:D,children:e.jsx(i,{styles:"w-full flex flex-col gap-5 px-10 py-5",children:e.jsx("ul",{className:"grid grid-cols-2 gap-2",children:B.map((t,s)=>e.jsx("li",{className:"flex flex-col",children:e.jsxs(i,{styles:"relative flex flex-col gap-2 py-5 px-10",children:[e.jsx("p",{className:"text-xl font-bold capitalize",children:t.name}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:()=>$(t.id),children:"Join"})]})},s))})})})})]})}export{H as Route};
