import{c as N,g as p,r as l,s as c,t as m,j as s,m as w,B as h}from"./index-BLGlSavF.js";const _=N("/chat")({component:S});function S(){const i=JSON.parse(p()).user.id,r=JSON.parse(p()).user.user_metadata.username,[g,u]=l.useState(""),[o,x]=l.useState([]),[j,f]=l.useState([]),b=async e=>{if(e.preventDefault(),e.target[0].value===""){m({style:"bg-error text-base-100",message:"Please enter a message"});return}const{error:t}=await c.from("messages").insert({content:e.target[0].value,user_id:i,username:r});u(""),t&&console.error("Error sending message:",t)},v=e=>{e.preventDefault(),u(e.target.value)},y=async()=>{let{data:e}=await c.from("messages").select("*").limit(50).order("created_at",{ascending:!1});x(t=>{var a;return[...t,...(a=e==null?void 0:e.reverse())==null?void 0:a.map(n=>n)]})},d=l.useRef(null);return l.useEffect(()=>{var e;o.length&&((e=d.current)==null||e.scrollIntoView({behavior:"smooth",block:"end"}))},[o.length]),l.useEffect(()=>{const e=c.channel("a");return e.on("presence",{event:"join"},({newPresences:t})=>{f(a=>[...a,t[0].user]),t[0].user!==r&&m({style:"bg-success text-base-100",message:`${t[0].user} joined the chat`})}).on("presence",{event:"leave"},({leftPresences:t})=>{f(a=>a.filter(n=>n!==t[0].user)),t[0].user!==r&&m({style:"bg-error text-base-100",message:`${t[0].user} left the chat`})}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},t=>{x(a=>[...a,t.new])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},t=>{x(a=>a.filter(n=>n.id!==t.old.id))}).subscribe(async t=>{t==="SUBSCRIBED"&&await y()}),e.track({user:r,online_at:new Date().toISOString()}),()=>{c.removeChannel(e)}},[]),s.jsx(w.main,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"m-0 h-full w-full p-0",children:s.jsxs(h,{styles:"w-full max-h-[80vh] flex px-5 py-5 gap-2 justify-between overflow-hidden",children:[s.jsxs("div",{className:" flex flex-col gap-5 px-2 py-5",children:[s.jsx("h1",{className:"text-center text-2xl font-semibold text-primary",children:"Active"}),s.jsx("ul",{className:"flex flex-col",children:j.map((e,t)=>s.jsx("li",{className:"flex flex-col text-left",children:s.jsxs("p",{className:"text-xl font-bold capitalize",children:[e,s.jsx("span",{className:"text-4xl text-success text-center leading-[1ch]",children:"Â·"})]})},t))})]}),s.jsxs("div",{className:"flex flex-col gap-5 w-full h-full",children:[s.jsxs(h,{styles:"w-full max-h-[70vh] flex flex-col flex-grow px-5 py-5 gap-5 overflow-y-scroll",children:[s.jsxs("ul",{className:"flex flex-col justify-start gap-2",children:[s.jsxs("li",{className:"flex flex-col text-left",children:[s.jsx("p",{className:"text-center text-xs text-slate-400",children:"System message"}),s.jsx("p",{className:"text-center text-accent",children:"Welcome to the chat!"})]}),o.map((e,t)=>s.jsx("li",{className:"flex flex-col text-left",children:s.jsxs("div",{className:"relative flex flex-col gap-2",children:[s.jsxs("p",{className:`text-xl font-bold capitalize ${e.user_id===i?"text-accent":"text-primary"}`,children:[e.username,e.user_id===i&&s.jsx("span",{className:"text-xs text-slate-400",children:" (Me)"})]}),s.jsxs("div",{className:"flex justify-between",children:[e.content,s.jsx("span",{className:"flex items-center justify-end text-accent",children:new Date(e.created_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})})]})]})},t))]}),s.jsx("div",{ref:d,className:"px-5 text-left"})]}),s.jsxs("form",{onSubmit:b,className:"flex gap-2",children:[s.jsx("input",{type:"text",value:g,onChange:v,placeholder:"Type a message...",className:"input input-bordered flex-grow"}),s.jsx("button",{type:"submit",className:"btn btn-primary",children:"Send"})]})]})]})})}export{_ as Route};
